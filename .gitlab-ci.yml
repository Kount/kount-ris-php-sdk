include:
  - project: kount/third_party/tpa-ci-shared
    file:
      - core/rules.yml
      - version.yml
      - base/sq-scan.yml
    ref: 2.4.0

stages:
  - version
  - version check
  - build
  - test
  - sonarqube scan

.php:
  image: roadiz/php73-runner
  before_script:
    # install dependencies
    - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
    - bash docker_install.sh
    - apt-get update
    - apt-get install zip unzip -y
    - php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    - php composer-setup.php
    - php -r "unlink('composer-setup.php');"
    - php composer.phar install
  script:
    - composer install

version check:
  stage: version check
  rules:
    # on master, allow failure
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      allow_failure: true
    # on mr, allow failure
    - if: '$CI_MERGE_REQUEST_ID != null || $CI_PIPELINE_SOURCE == "merge_request_event"'
      allow_failure: true
    - !reference [.rule-on-tag]
  script:
    - BUILD_VERSION=`echo $BUILD_VERSION | cut -c-20`
    - SDK_VERSION="Sdk-Ris-PHP-"${BUILD_VERSION}
    - |
      if [ "$(grep -q 'SDK_VERSION=\"${SDK_VERSION}\"' src/settings.ini)" != "0" ]
      then
        echo "'SDK_VERSION=\"${SDK_VERSION}\"' not found"
        echo "Change SDK_VERSION to 'Sdk-Ris-PHP-next_expected_tag' in src/settings.ini"
        exit 1
      fi

build:
  stage: build
  extends: .php
  rules:
    - !reference [.rule-on-tag]
    - !reference [.rule-on-master]
    - !reference [.rule-on-mr]
  
test:
  extends: .php
  rules:
  - !reference [.rule-on-tag]
  - !reference [.rule-on-master]
  - !reference [.rule-on-mr]
  script:
    - phpunit --configuration phpunit.integration.xml

sonarqube scan:
  extends: .sq-scan
  stage: sonarqube scan
  allow_failure: true
  variables:
    SRC_EXCLUSIONS: "**/.git/**,**/build/**,**/vendor/**,**/docs/**,**/phpdocs/**,**/DS_Store/**,**/idea/**,**/*LICENSE,**/*.cache,**/*.lock,**/*.phar,**/*.gitignore,**/*.yml"